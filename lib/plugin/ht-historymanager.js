!function(M,$,d){"use strict";var H="ht",r=M[H],p=r.Default,R=p.def,m=p.getInternal();r.HistoryManager=function(I){this._histories=[],this.setDataModel(I)},R(r.HistoryManager,$,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var M=this;M._betweenTransaction++,1===M._betweenTransaction&&(M._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var f=this,_=f._histories;if(f._betweenTransaction>0&&f._betweenTransaction--,0===f._betweenTransaction){if(f._transactionHistories){var A=[];for(var t in f._transactionHistories)A.push(f._transactionHistories[t]);A.length&&(_=_.slice(0,f._historyIndex+1),_.push(A),_.length>f._maxHistoryCount&&(_=_.slice(_.length-f._maxHistoryCount)),f.setHistories(_),f.setHistoryIndex(_.length-1,!0))}delete f._transactionHistories}}},setDataModel:function(B){var n=this,C=n._dataModel;C!==B&&(C&&(delete C._historyManager,C.ump(n.handleDataModelPropertyChange,n),C.umm(n.$5p,n),C.umd(n.$6p,n),C.removeHierarchyChangeListener(n.handleHierarchyChange,n),C.removeIndexChangeListener(n.handleIndexChange,n)),n._dataModel=B,B&&(B._historyManager=n,B.mp(n.handleDataModelPropertyChange,n),B.mm(n.$5p,n),B.md(n.$6p,n),B.addHierarchyChangeListener(n.handleHierarchyChange,n),B.addIndexChangeListener(n.handleIndexChange,n)),n.fp("dataModel",C,B),n.clear())},setHistoryIndex:function(I,w){var Z=this,o=Z._historyIndex,g=Z._histories.length;if(-1>I?I=-1:I>=g&&(I=g-1),o!==I){if(!w){var j=I-o;j>0?Z.$2p(j):0>j&&Z.$1p(-j)}Z._historyIndex=I,Z.fp("historyIndex",o,I),Z.dataModel&&Z.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(O){var N=this,q=N._histories,l=N._maxHistoryCount;(!O||0>=O)&&(O=10),l!==O&&(N._maxHistoryCount=O,N.fp("maxHistoryCount",l,O),q.length>O&&N.clear())},cloneValue:function(H){return r.Default.clone(H)},isPropertyUndoable:function(j){return j&&!this.ignoredPropertyMap[j]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(L){return L&&!this.ignoreDataModelPropertyMap[L]},$5p:function(x){this.handleChange(x,x.kind)},$6p:function(_){this.handleChange(_,"property")},handleHierarchyChange:function(L){this.handleChange(L,"hierarchy")},handleIndexChange:function(w){this.handleChange(w,"index")},handleDataModelPropertyChange:function(w){this.handleChange(w,"dataModelProperty")},toChildrenInfo:function(B){var o={};return o.data=B,o.children=[],B.eachChild(function(s){o.children.push(this.toChildrenInfo(s))},this),o},restoreChildren:function(d){var M=d.data;d.children.forEach(function(r){var p=r.data;p.getParent()!==M&&M.addChild(p),this._dataModel.contains(p)||this._dataModel.add(p),this.restoreChildren(r)},this)},handleChange:function(j,D){var m=this;if(!(m._disabled||m._isUndoRedoing||p.loadingRefGraph)){var A,G=(m._histories,j.data),w=j.property;if(!G||!(G._refGraph||G instanceof r.RefGraph)){if("property"===D)m.isPropertyUndoable(w,G)&&(A={kind:D,data:G,property:w,oldValue:m.cloneValue(j.oldValue,G,w),newValue:m.cloneValue(j.newValue,G,w),event:j});else if("hierarchy"===D||"index"===D&&m.isIndexUndoable(j))A={kind:D,data:G,oldIndex:j.oldIndex,newIndex:j.newIndex,event:j};else if("clear"===D)A={kind:D,json:j.json,event:j};else if("add"===D){if(A={kind:D,data:G,event:j,childrenInfo:this.toChildrenInfo(G),parent:G.getParent()},A.parent){var M=m._dataModel.getSiblings(G);A.siblingsIndex=M.indexOf(G)}G instanceof r.Node&&(A.host=G.getHost(),A.attaches=G.getAttaches()?G.getAttaches().toArray():d),G instanceof r.Edge&&(A.source=G.getSource(),A.target=G.getTarget())}else"remove"===D?A={kind:D,data:G,event:j}:"dataModelProperty"===D&&m.isDataModelPropertyUndoable(w,G)&&(A={kind:D,property:w,oldValue:m.cloneValue(j.oldValue,G,w),newValue:m.cloneValue(j.newValue,G,w),event:j});m.addHistory(A)}}},addHistory:function(J){var R=this;if(J)if(R._betweenTransaction){var F=(J.data?J.data._id:0)+"_"+J.kind+"_"+J.property;if("property"===J.kind||"dataModelProperty"===J.kind){var s=R._transactionHistories[F];s&&(J.oldValue=s.oldValue)}R._transactionHistories[F]=J}else{var $=R._histories;$=$.slice(0,R._historyIndex+1),$.push([J]),$.length>R._maxHistoryCount&&($=$.slice($.length-R._maxHistoryCount)),R.setHistories($),R.setHistoryIndex($.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(C){(!C||0>=C)&&(C=1),this.setHistoryIndex(this._historyIndex-C)},$1p:function(g){if(this.canUndo()){var R,T=this,K=T._dataModel,C=T._histories,J=T._historyIndex,O=0;for(T._isUndoRedoing=!0,p.setIsolating(!0);g>0;){if(J>=0&&J<C.length){O++,R=C[J],J--;for(var E=R.length-1;E>=0;E--){var X=R[E],H=X.kind,s=X.data,V=X.property,j=X.event,A=this.cloneValue(X.oldValue,s,V);if(X.undo)X.undo();else if("add"===H)K.remove(s,{keepChildren:!0});else if("remove"===H)K.contains(s)||K.add(s,j.rootsIndex,j.datasIndex);else if("clear"===H)K.deserialize(p.clone(X.json));else if("property"===H)if("parent"===V)A?A.addChild(s,j.oldIndex):(s.setParent(A),j.oldIndex>=0&&K.moveTo(s,j.oldIndex));else{var q=null;0===V.indexOf("a:")?(q="attr",V=V.replace("a:","")):0===V.indexOf("s:")?(q="style",V=V.replace("s:","")):0===V.indexOf("f:")&&(q="field",V=V.replace("f:","")),m.setPropertyValue(s,q,V,A)}else if("dataModelProperty"===H){var q=null;0===V.indexOf("a:")?(q="attr",V=V.replace("a:","")):0===V.indexOf("s:")?(q="style",V=V.replace("s:","")):0===V.indexOf("f:")&&(q="field",V=V.replace("f:","")),m.setPropertyValue(K,q,V,A)}else"hierarchy"===H?K.moveTo(s,X.oldIndex):"index"===H?K.moveToIndex(s,X.oldIndex):"selection"===H&&K.sm().ss(X.oldValue)}}g--}p.setIsolating(!1),delete T._isUndoRedoing,T.afterUndo(O)}},afterUndo:function(){},redo:function(y){(!y||0>=y)&&(y=1),this.setHistoryIndex(this._historyIndex+y)},$2p:function(x){if(this.canRedo()){var l,M=this,Q=M._dataModel,W=M._histories,A=M._historyIndex,n=0;for(M._isUndoRedoing=!0,p.setIsolating(!0);x>0;){if(A>=-1&&A<W.length-1){n++,A++,l=W[A];for(var O=0;O<l.length;O++){var I=l[O],e=I.kind,y=I.data,Z=I.property,o=I.event,b=this.cloneValue(I.newValue,y,Z);if(I.redo)I.redo();else if("add"===e)I.parent&&!y.getParent()&&I.parent.addChild(y,I.siblingsIndex),Q.contains(y)||Q.add(y,o.rootsIndex,o.datasIndex),this.restoreChildren(I.childrenInfo),y instanceof r.Node&&(y.setHost(I.host),I.attaches&&I.attaches.forEach(function(v){v.setHost(y)})),y instanceof r.Edge&&(y.setSource(I.source),y.setTarget(I.target));else if("remove"===e)Q.remove(y);else if("clear"===e)Q.clear();else if("property"===e)if("parent"===Z)b?b.addChild(y,o.newIndex):(y.setParent(b),o.newIndex>=0&&Q.moveTo(y,o.newIndex));else{var g=null;0===Z.indexOf("a:")?(g="attr",Z=Z.replace("a:","")):0===Z.indexOf("s:")?(g="style",Z=Z.replace("s:","")):0===Z.indexOf("f:")&&(g="field",Z=Z.replace("f:","")),m.setPropertyValue(y,g,Z,b)}else if("dataModelProperty"===e){var g=null;0===Z.indexOf("a:")?(g="attr",Z=Z.replace("a:","")):0===Z.indexOf("s:")?(g="style",Z=Z.replace("s:","")):0===Z.indexOf("f:")&&(g="field",Z=Z.replace("f:","")),m.setPropertyValue(Q,g,Z,b)}else"hierarchy"===e?Q.moveTo(y,I.newIndex):"index"===e?Q.moveToIndex(y,I.newIndex):"selection"===e&&Q.sm().ss(I.newValue)}}x--}p.setIsolating(!1),delete M._isUndoRedoing,this.afterRedo(n)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);